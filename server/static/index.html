<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tone Engine</title>
  <style>
    :root { --fg:#0f1226; --muted:#6b7280; --accent:#6c5ce7; --accent2:#a855f7; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 1080px; color: var(--fg); }
    h1 { margin-bottom: 4px; }
    p.lead { color: var(--muted); margin-top: 0; margin-bottom: 16px; }
    .row { display: flex; gap: 24px; align-items: stretch; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 18px; flex: 1; transition: transform .18s ease, box-shadow .18s ease; background: #fff; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 14px 28px rgba(17,24,39,.08); }
    label { display: block; margin-top: 10px; font-weight: 600; }
    input, select, textarea, button { width: 100%; padding: 10px 12px; margin-top: 6px; border-radius: 10px; border: 1px solid #e5e7eb; }
    button { background: linear-gradient(135deg, var(--accent), var(--accent2)); border: none; color: #fff; font-weight: 600; cursor: pointer; transition: transform .18s ease, box-shadow .18s ease; }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 18px rgba(17,24,39,.12); }
    textarea { height: 160px; }
    pre { background: #0b1021; color: #e5e7eb; padding: 12px; border-radius: 10px; overflow: auto; }
    .row-narrow { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; align-items: end; }

    /* Subtle fade-in */
    .reveal { opacity: 0; transform: translateY(8px); transition: opacity .45s ease, transform .45s ease; }
    .reveal.visible { opacity: 1; transform: none; }

    @media (max-width: 900px) { .row { flex-direction: column; } .row-narrow { grid-template-columns: 1fr; } }
    @media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition: none !important } }
  </style>
</head>
<body>
  <h1 class="reveal">Tone Engine</h1>
  <p class="lead reveal">Upload transcript(s) to build a voice profile, then rephrase text in that voice.</p>

  <div class="card reveal">
    <h3>Identify yourself</h3>
    <div class="row-narrow">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
      </div>
      <div>
        <button id="ensureClient">Use this email</button>
      </div>
      <div>
        <label>Client</label>
        <select id="client"></select>
      </div>
    </div>
    <small id="ensureMsg"></small>
  </div>

  <div class="row" style="margin-top:24px;">
    <div class="card reveal">
      <h3>1) Upload transcript</h3>
      <input type="file" id="file" accept=".txt" />
      <button id="uploadBtn">Process Transcript</button>
      <pre id="uploadOut"></pre>
    </div>

    <div class="card reveal">
      <h3>2) Rephrase in tone</h3>
      <label for="inputText">Input text</label>
      <textarea id="inputText" placeholder="Paste text to rephrase..."></textarea>
      <button id="rephraseBtn">Rephrase</button>
      <label>Output</label>
      <textarea id="outputText" readonly></textarea>
    </div>
  </div>

  <div class="card reveal" style="margin-top:24px;">
    <h3>Profile (JSON)</h3>
    <button id="loadProfile">Load Profile</button>
    <pre id="profileJson"></pre>
  </div>

  <div class="card reveal" style="margin-top:24px;">
    <h3>4) Generate with Brief</h3>
    <div class="row-narrow" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
      <div>
        <label>Platform</label>
        <select id="gPlatform">
          <option value="generic" selected>Generic</option>
          <option value="twitter">Twitter/X</option>
          <option value="linkedin">LinkedIn</option>
        </select>
      </div>
      <div>
        <label>Content type</label>
        <select id="gType">
          <option>post</option>
          <option>thread</option>
          <option>email</option>
          <option>blog</option>
        </select>
      </div>
      <div>
        <label>Length</label>
        <select id="gLength">
          <option>short</option>
          <option selected>medium</option>
          <option>long</option>
        </select>
      </div>
      <div>
        <label>Audience</label>
        <input id="gAudience" placeholder="e.g., SaaS founders" />
      </div>
      <div>
        <label>Objective</label>
        <input id="gObjective" placeholder="e.g., drive signups" />
      </div>
    </div>
    <label>Must include (comma-separated)</label>
    <input id="gMust" placeholder="e.g., product name, CTA" />
    <label>Avoid (comma-separated)</label>
    <input id="gAvoid" placeholder="e.g., buzzwords" />
    <label>Prompt/Topic</label>
    <textarea id="gPrompt" placeholder="Topic or seed..."></textarea>
    <button id="gBtn">Generate</button>
    <label>Output</label>
    <textarea id="gOut" readonly></textarea>
  </div>

  <script>
    // Reveal on load/scroll
    (function(){
      const els = document.querySelectorAll('.reveal');
      if (!('IntersectionObserver' in window)) {
        els.forEach(el => el.classList.add('visible'));
        return;
      }
      const io = new IntersectionObserver((entries, obs) => {
        entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); obs.unobserve(e.target); }});
      }, { threshold: 0.12 });
      els.forEach(el => io.observe(el));
    })();

    const clientSel = document.getElementById('client');
    const uploadOut = document.getElementById('uploadOut');
    const outputText = document.getElementById('outputText');
    const profileJson = document.getElementById('profileJson');
    const ensureMsg = document.getElementById('ensureMsg');

    function store(key, value){ localStorage.setItem(key, value); }
    function load(key, def=''){ return localStorage.getItem(key) || def; }

    async function loadClients(email) {
      try {
        const qs = email ? `?email=${encodeURIComponent(email)}` : '';
        const res = await fetch('/api/clients' + qs);
        const data = await res.json();
        clientSel.innerHTML = '';
        const names = data.clients || ['default'];
        names.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name; clientSel.appendChild(opt);
        });
        const saved = load('client');
        if (saved && names.includes(saved)) clientSel.value = saved;
      } catch (e) {
        console.error(e);
        clientSel.innerHTML = '<option value="default">default</option>';
      }
    }

    async function ensureClientByEmail() {
      const email = document.getElementById('email').value.trim();
      if (!email) { ensureMsg.textContent = 'Enter your email.'; return; }
      ensureMsg.textContent = 'Checking...';
      const res = await fetch('/api/ensureClient', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      ensureMsg.textContent = `Using client: ${data.client}`;
      store('email', email);
      store('client', data.client);
      await loadClients(email);
      clientSel.value = data.client;
    }

    async function processTranscript() {
      const file = document.getElementById('file').files[0];
      if (!file) { uploadOut.textContent = 'Choose a .txt file first.'; return; }
      const form = new FormData();
      form.append('client', clientSel.value || 'default');
      form.append('file', file);
      uploadOut.textContent = 'Processing...';
      const res = await fetch('/api/processTranscript', { method: 'POST', body: form });
      const data = await res.json();
      uploadOut.textContent = JSON.stringify(data, null, 2);
    }

    async function rephrase() {
      const text = document.getElementById('inputText').value;
      const body = { client: clientSel.value || 'default', text };
      outputText.value = 'Working...';
      const res = await fetch('/api/rephrase', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)});
      const data = await res.json();
      outputText.value = data.result || JSON.stringify(data);
    }

    async function loadProfile() {
      profileJson.textContent = 'Loading...';
      const c = clientSel.value || 'default';
      const res = await fetch(`/api/profile?client=${encodeURIComponent(c)}`);
      if (res.ok) {
        const data = await res.json();
        profileJson.textContent = JSON.stringify(data, null, 2);
      } else {
        profileJson.textContent = 'No profile found yet. Upload a transcript first.';
      }
    }

    async function generateWithBrief(){
      const body = {
        client: clientSel.value || 'default',
        content_type: document.getElementById('gType').value,
        audience: document.getElementById('gAudience').value,
        objective: document.getElementById('gObjective').value,
        length: document.getElementById('gLength').value,
        must: (document.getElementById('gMust').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        avoid: (document.getElementById('gAvoid').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        prompt: document.getElementById('gPrompt').value,
        platform: document.getElementById('gPlatform').value,
      };
      const out = document.getElementById('gOut');
      out.value = 'Working...';
      const res = await fetch('/api/generateWithBrief', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const data = await res.json();
      out.value = data.result || JSON.stringify(data);
    }

    document.getElementById('ensureClient').onclick = ensureClientByEmail;
    document.getElementById('uploadBtn').onclick = processTranscript;
    document.getElementById('rephraseBtn').onclick = rephrase;
    document.getElementById('loadProfile').onclick = loadProfile;
    document.getElementById('gBtn').onclick = generateWithBrief;

    // Init
    const savedEmail = load('email');
    if (savedEmail) document.getElementById('email').value = savedEmail;
    loadClients(savedEmail);
  </script>
</body>
</html>